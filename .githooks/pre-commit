#!/bin/bash

echo "ğŸ” Running pre-commit checks..."

# å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œå‡º
BACKEND_CHANGED=$(git diff --cached --name-only | grep "^backend/" | wc -l)
FRONTEND_CHANGED=$(git diff --cached --name-only | grep "^frontend/" | wc -l)

EXIT_CODE=0

# Backend ãƒã‚§ãƒƒã‚¯
if [ "$BACKEND_CHANGED" -gt 0 ]; then
  echo ""
  echo "ğŸ“¦ Backend changes detected"

  echo "  âš™ï¸  Running RuboCop..."
  docker-compose exec -T backend rubocop --parallel
  if [ $? -ne 0 ]; then
    echo "  âŒ RuboCop failed. Run 'docker-compose exec backend rubocop -A' to auto-fix."
    EXIT_CODE=1
  else
    echo "  âœ… RuboCop passed"
  fi

  echo "  âš™ï¸  Running RSpec..."
  docker-compose exec -T backend rspec
  if [ $? -ne 0 ]; then
    echo "  âŒ RSpec tests failed"
    EXIT_CODE=1
  else
    echo "  âœ… RSpec tests passed"
  fi
fi

# Frontend ãƒã‚§ãƒƒã‚¯
if [ "$FRONTEND_CHANGED" -gt 0 ]; then
  echo ""
  echo "ğŸ¨ Frontend changes detected"

  echo "  âš™ï¸  Running ESLint..."
  docker-compose exec -T frontend npm run lint
  if [ $? -ne 0 ]; then
    echo "  âŒ ESLint failed. Run 'docker-compose exec frontend npm run lint:fix' to auto-fix."
    EXIT_CODE=1
  else
    echo "  âœ… ESLint passed"
  fi

  echo "  âš™ï¸  Running TypeScript check..."
  docker-compose exec -T frontend npm run type-check
  if [ $? -ne 0 ]; then
    echo "  âŒ TypeScript check failed"
    EXIT_CODE=1
  else
    echo "  âœ… TypeScript check passed"
  fi
fi

if [ $EXIT_CODE -eq 0 ]; then
  echo ""
  echo "âœ… All pre-commit checks passed!"
else
  echo ""
  echo "âŒ Pre-commit checks failed. Please fix the issues before committing."
  echo ""
  echo "ğŸ’¡ Tips:"
  echo "  - Run auto-fix commands mentioned above"
  echo "  - Use 'git commit --no-verify' to skip checks (not recommended)"
fi

exit $EXIT_CODE
