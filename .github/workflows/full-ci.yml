name: Full Stack CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for changes
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
              - '.github/workflows/backend-ci.yml'
              - '.github/workflows/full-ci.yml'
            frontend:
              - 'frontend/**'
              - '.github/workflows/frontend-ci.yml'
              - '.github/workflows/full-ci.yml'

  backend-ci:
    name: Backend CI
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    uses: ./.github/workflows/backend-ci.yml

  frontend-ci:
    name: Frontend CI
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    uses: ./.github/workflows/frontend-ci.yml

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [backend-ci, frontend-ci]
    if: |
      always() &&
      (needs.backend-ci.result == 'success' || needs.backend-ci.result == 'skipped') &&
      (needs.frontend-ci.result == 'success' || needs.frontend-ci.result == 'skipped')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create .env file
        run: cp .env.example .env

      - name: Build and start services
        run: docker-compose up -d --build

      - name: Wait for services
        run: |
          echo "Waiting for backend to be ready..."
          timeout 60 bash -c 'until curl -f http://localhost:3001/health > /dev/null 2>&1; do sleep 2; done'
          echo "Backend is ready!"

          echo "Waiting for frontend to be ready..."
          timeout 60 bash -c 'until curl -f http://localhost:3000 > /dev/null 2>&1; do sleep 2; done'
          echo "Frontend is ready!"

      - name: Test backend health
        run: |
          response=$(curl -s http://localhost:3001/health)
          echo "Backend response: $response"
          echo "$response" | grep -q "ok"

      - name: Test frontend
        run: |
          curl -f http://localhost:3000 > /dev/null

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Backend logs ==="
          docker-compose logs backend
          echo "=== Frontend logs ==="
          docker-compose logs frontend
          echo "=== Database logs ==="
          docker-compose logs db

      - name: Cleanup
        if: always()
        run: docker-compose down -v

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [backend-ci, frontend-ci, integration]
    if: always()

    steps:
      - name: Check all results
        run: |
          echo "Backend CI: ${{ needs.backend-ci.result }}"
          echo "Frontend CI: ${{ needs.frontend-ci.result }}"
          echo "Integration: ${{ needs.integration.result }}"

          backend_result="${{ needs.backend-ci.result }}"
          frontend_result="${{ needs.frontend-ci.result }}"
          integration_result="${{ needs.integration.result }}"

          # Check if any job failed
          if [ "$backend_result" == "failure" ] || \
             [ "$frontend_result" == "failure" ] || \
             [ "$integration_result" == "failure" ]; then
            echo "❌ CI Pipeline failed"
            exit 1
          else
            echo "✅ All CI checks passed"
          fi
